<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BattlePets - Web3 Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f9f9f9;
    }
    h1 { color: #2c3e50; }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
    }
    button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }
    .info-box {
      background: #ecf0f1;
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
    }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>

<h1>⚔️ BattlePets 链游</h1>

<div id="wallet-status">未连接钱包</div>
<div id="player-info" class="info-box" style="display:none;"></div>

<button id="connectBtn">连接钱包 (MetaMask)</button>
<button id="mintBtn" disabled>铸造你的宠物</button>

<div id="pet-section" style="display:none;">
  <h2>你的宠物</h2>
  <div id="pet-stats"></div>
  <button id="upgradeStrBtn">升级力量（-10 荣誉）</button>
  <button id="upgradeAgiBtn">升级敏捷（-10 荣誉）</button>
</div>

<div id="npc-section" style="display:none;">
  <h2>挑战 NPC</h2>
  <button id="challengeGoblin">挑战 Goblin（奖励 5）</button>
  <button id="challengeOrc">挑战 Orc（奖励 10）</button>
  <button id="challengeDragon">挑战 Dragon（奖励 20）</button>
</div>

<div id="messages" style="margin-top: 20px;"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"" type="application/javascript"></script>
<script>
  // ===== 配置区 =====
  const CONTRACT_ADDRESS = "0x19DE5Ff1D6D0e377E3C5762eF8B3fCaeEC0D13e7"; // ←←← 替换为你的 Sepolia 合约地址！
  const CHAIN_ID = "0xaa36a7"; // Sepolia 的 chainId (十进制 11155111)

  // ABI（只包含需要的方法）
  const CONTRACT_ABI = [
    "function mintPet()",
    "function getPlayerPetId(address) view returns (uint256)",
    "function getPlayerHonor(address) view returns (uint256)",
    "function getPetStats(uint256) view returns (uint256 strength, uint256 agility, uint256 wins)",
    "function getPetLimits(uint256) view returns (uint256 maxStrength, uint256 maxAgility)",
    "function upgradeStrength()",
    "function upgradeAgility()",
    "function challengeNpc(uint256 npcId)",
    "event BattleResult(address indexed attacker, address indexed defender, bool attackerWon, uint256 reward)"
  ];

  // 全局变量
  let provider, signer, contract, account;

  // DOM 元素
  const walletStatusEl = document.getElementById("wallet-status");
  const playerInfoEl = document.getElementById("player-info");
  const petSectionEl = document.getElementById("pet-section");
  const petStatsEl = document.getElementById("pet-stats");
  const npcSectionEl = document.getElementById("npc-section");
  const messagesEl = document.getElementById("messages");

  // 工具函数：显示消息
  function showMessage(text, isError = false) {
    const div = document.createElement("div");
    div.className = isError ? "error" : "success";
    div.innerText = text;
    messagesEl.appendChild(div);
    setTimeout(() => div.remove(), 5000);
  }

  // 初始化
  async function init() {
    if (typeof window.ethereum !== "undefined") {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await checkNetworkAndAccount();
    } else {
      showMessage("请安装 MetaMask 钱包", true);
    }
  }

  async function checkNetworkAndAccount() {
    try {
      const network = await provider.getNetwork();
      if (network.chainId !== parseInt(CHAIN_ID, 16)) {
        showMessage("请切换到 Sepolia 测试网", true);
        return;
      }

      const accounts = await provider.listAccounts();
      if (accounts.length > 0) {
        account = accounts[0];
        await setupContract();
        await updateUI();
      }
    } catch (err) {
      console.error(err);
    }
  }

  async function connectWallet() {
    try {
      await provider.send("eth_requestAccounts", []);
      account = (await provider.listAccounts())[0];
      await setupContract();
      await updateUI();
      walletStatusEl.innerText = `已连接: ${account.substring(0,6)}...${account.substring(account.length-4)}`;
    } catch (err) {
      showMessage("连接钱包失败", true);
    }
  }

  function setupContract() {
    signer = provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
  }

  async function updateUI() {
    if (!account || !contract) return;

    try {
      const petId = await contract.getPlayerPetId(account);
      const honor = await contract.getPlayerHonor(account);

      playerInfoEl.style.display = "block";
      playerInfoEl.innerHTML = `<strong>地址:</strong> ${account.substring(0,6)}...${account.substring(account.length-4)}<br>
                                <strong>荣誉点数:</strong> ${honor}`;

      if (petId > 0) {
        const [strength, agility, wins] = await contract.getPetStats(petId);
        const [maxStr, maxAgi] = await contract.getPetLimits(petId);
        petStatsEl.innerHTML = `
          <p><strong>宠物 ID:</strong> ${petId}</p>
          <p><strong>力量:</strong> ${strength} / ${maxStr}</p>
          <p><strong>敏捷:</strong> ${agility} / ${maxAgi}</p>
          <p><strong>胜场:</strong> ${wins}</p>
        `;
        petSectionEl.style.display = "block";
        npcSectionEl.style.display = "block";
        document.getElementById("mintBtn").disabled = true;
      } else {
        document.getElementById("mintBtn").disabled = false;
      }
    } catch (err) {
      console.error(err);
      showMessage("读取数据失败", true);
    }
  }

  // 绑定事件
  document.getElementById("connectBtn").addEventListener("click", connectWallet);
  document.getElementById("mintBtn").addEventListener("click", async () => {
    try {
      const tx = await contract.mintPet();
      showMessage("正在铸造宠物，请等待交易确认...");
      await tx.wait();
      showMessage("宠物铸造成功！");
      await updateUI();
    } catch (err) {
      showMessage("铸造失败: " + (err.reason || err.message), true);
    }
  });

  document.getElementById("upgradeStrBtn").addEventListener("click", async () => {
    try {
      const tx = await contract.upgradeStrength();
      await tx.wait();
      showMessage("力量升级成功！");
      await updateUI();
    } catch (err) {
      showMessage("升级失败: " + (err.reason || err.message), true);
    }
  });

  document.getElementById("upgradeAgiBtn").addEventListener("click", async () => {
    try {
      const tx = await contract.upgradeAgility();
      await tx.wait();
      showMessage("敏捷升级成功！");
      await updateUI();
    } catch (err) {
      showMessage("升级失败: " + (err.reason || err.message), true);
    }
  });

  // NPC 挑战
  document.getElementById("challengeGoblin").addEventListener("click", () => challengeNpc(0));
  document.getElementById("challengeOrc").addEventListener("click", () => challengeNpc(1));
  document.getElementById("challengeDragon").addEventListener("click", () => challengeNpc(2));

  async function challengeNpc(npcId) {
    try {
      const tx = await contract.challengeNpc(npcId);
      showMessage("正在挑战 NPC，请等待结果...");
      await tx.wait();
      showMessage("挑战完成！查看荣誉点数变化。");
      await updateUI();
    } catch (err) {
      showMessage("挑战失败: " + (err.reason || err.message), true);
    }
  }

  // 监听网络/账户切换
  window.ethereum.on('accountsChanged', () => location.reload());
  window.ethereum.on('chainChanged', () => location.reload());

  // 启动
  init();
</script>

</body>
</html>
