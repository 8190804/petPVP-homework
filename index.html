<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Battle Pets - Sepolia</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
    button { margin: 5px; padding: 8px 12px; }
    .info { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>âš”ï¸ Battle Pets (Sepolia Testnet)</h1>

  <div id="app">
    <button id="connectBtn">ğŸ”Œ è¿æ¥ MetaMask</button>
    <div id="content" style="display:none;">
      <p><strong>é’±åŒ…:</strong> <span id="account"></span></p>
      <p><strong>è£èª‰ç‚¹:</strong> <span id="honor">0</span></p>

      <div id="noPet" style="display:none;">
        <button id="mintBtn">ğŸ¾ å¬å”¤ä½ çš„æˆ˜æ–—å® ç‰©ï¼</button>
      </div>

      <div id="petInfo" style="display:none;">
        <h3>ä½ çš„å® ç‰© #<span id="petId"></span></h3>
        <div class="info">
          åŠ›é‡: <span id="strength">0</span> | 
          æ•æ·: <span id="agility">0</span> | 
          èƒœåœº: <span id="wins">0</span>
        </div>
        <button id="upgradeStr">ğŸ”º å‡çº§åŠ›é‡ (10 è£èª‰)</button>
        <button id="upgradeAgi">ğŸ”º å‡çº§æ•æ· (10 è£èª‰)</button>
        <h4>æŒ‘æˆ˜ NPC:</h4>
        <button id="goblin">ğŸ‘¾ Goblin</button>
        <button id="orc">ğŸ‘¹ Orc</button>
        <button id="dragon">ğŸ‰ Dragon</button>
      </div>
    </div>
    <p id="message" style="color:red; font-weight:bold;"></p>
  </div>

  <!-- ä½¿ç”¨ ESM ç‰ˆæœ¬çš„ ethers.jsï¼ˆæ—  evalï¼Œå…¼å®¹ CSPï¼‰ -->
  <script type="module">
    // ä»å®˜æ–¹ CDN å¯¼å…¥ ESM ç‰ˆæœ¬ï¼ˆv6ï¼‰
    import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js";

    // ğŸ‘‡ æ›¿æ¢ä¸ºä½ çš„åˆçº¦åœ°å€
    const CONTRACT_ADDRESS = "0xYourContractAddressHere0x19DE5Ff1D6D0e377E3C5762eF8B3fCaeEC0D13e7";

    const ABI = [
      "function mintPet()",
      "function getPlayerPetId(address) view returns (uint256)",
      "function getPetStats(uint256) view returns (uint256, uint256, uint256)",
      "function getPlayerHonor(address) view returns (uint256)",
      "function challengeNpc(uint256)",
      "function upgradeStrength()",
      "function upgradeAgility()",
      "event BattleResult(address indexed attacker, address indexed defender, bool attackerWon, uint256 reward)"
    ];

    let provider, signer, contract, account;

    async function init() {
      if (typeof window.ethereum !== 'undefined') {
        document.getElementById('connectBtn').onclick = connect;
      } else {
        alert('è¯·å®‰è£… MetaMaskï¼');
      }
    }

    async function connect() {
      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        account = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        document.getElementById('account').innerText = account.slice(0,6) + '...' + account.slice(-4);
        document.getElementById('connectBtn').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        // ç›‘å¬äº‹ä»¶ï¼ˆethers v6 è¯­æ³•ï¼‰
        contract.on("BattleResult", (attacker, defender, won, reward, event) => {
          showMessage(`âš”ï¸ ${won ? 'èƒœåˆ©' : 'å¤±è´¥'}! è·å¾— ${reward} è£èª‰ç‚¹`);
        });

        loadUserData();
      } catch (err) {
        console.error(err);
        alert('è¿æ¥å¤±è´¥');
      }
    }

    async function loadUserData() {
      try {
        const petId = await contract.getPlayerPetId(account);
        const honor = await contract.getPlayerHonor(account);
        document.getElementById('honor').innerText = honor.toString();

        if (petId.toString() === "0") {
          document.getElementById('noPet').style.display = 'block';
          document.getElementById('petInfo').style.display = 'none';
        } else {
          document.getElementById('noPet').style.display = 'none';
          document.getElementById('petInfo').style.display = 'block';
          document.getElementById('petId').innerText = petId.toString();

          const [str, agi, wins] = await contract.getPetStats(petId);
          document.getElementById('strength').innerText = str.toString();
          document.getElementById('agility').innerText = agi.toString();
          document.getElementById('wins').innerText = wins.toString();
        }
      } catch (err) {
        console.error(err);
      }
    }

    function showMessage(msg) {
      const el = document.getElementById('message');
      el.innerText = msg;
      setTimeout(() => el.innerText = '', 5000);
    }

    window.addEventListener('load', () => {
      init();

      document.getElementById('mintBtn').onclick = async () => {
        try {
          const tx = await contract.mintPet();
          await tx.wait();
          loadUserData();
        } catch (e) { console.error(e); }
      };

      document.getElementById('upgradeStr').onclick = async () => {
        try {
          const tx = await contract.upgradeStrength();
          await tx.wait();
          loadUserData();
        } catch (e) { console.error(e); }
      };

      document.getElementById('upgradeAgi').onclick = async () => {
        try {
          const tx = await contract.upgradeAgility();
          await tx.wait();
          loadUserData();
        } catch (e) { console.error(e); }
      };

      document.getElementById('goblin').onclick = () => challenge(0);
      document.getElementById('orc').onclick = () => challenge(1);
      document.getElementById('dragon').onclick = () => challenge(2);

      async function challenge(npcId) {
        try {
          const tx = await contract.challengeNpc(npcId);
          await tx.wait();
          loadUserData();
        } catch (e) { console.error(e); }
      }
    });
  </script>

  <p style="font-size:12px;color:#666;margin-top:30px;">
    â„¹ï¸ éœ€è¦ Sepolia æµ‹è¯•å¸ï¼Ÿè®¿é—® <a href="https://sepoliafaucet.com" target="_blank">sepoliafaucet.com</a>
  </p>
</body>
</html>

